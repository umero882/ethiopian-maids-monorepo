# Placement Workflow Mutations
# These mutations support the placement workflow state machine

mutation CreatePlacementWorkflow(
  $sponsorId: String!
  $agencyId: String
  $maidId: String!
  $platformFeeAmount: numeric!
  $platformFeeCurrency: String!
) {
  insert_placement_workflows_one(
    object: {
      sponsor_id: $sponsorId
      agency_id: $agencyId
      maid_id: $maidId
      status: "contact_initiated"
      platform_fee_amount: $platformFeeAmount
      platform_fee_currency: $platformFeeCurrency
      fee_status: "pending"
    }
  ) {
    id
    status
    contact_date
    platform_fee_amount
    platform_fee_currency
    created_at
  }
}

mutation UpdatePlacementWorkflowStatus(
  $id: uuid!
  $status: String!
  $feeStatus: String
  $notes: jsonb
) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: {
      status: $status
      fee_status: $feeStatus
      notes: $notes
    }
  ) {
    id
    status
    fee_status
    updated_at
  }
}

mutation ScheduleInterview($id: uuid!, $interviewDate: timestamptz!) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: {
      status: "interview_scheduled"
      interview_scheduled_date: $interviewDate
    }
  ) {
    id
    status
    interview_scheduled_date
    updated_at
  }
}

mutation CompleteInterview($id: uuid!, $outcome: String!) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: {
      status: "interview_completed"
      interview_outcome: $outcome
      interview_completed_date: "now()"
    }
  ) {
    id
    status
    interview_outcome
    interview_completed_date
    updated_at
  }
}

mutation StartTrialPeriod($id: uuid!, $trialEndDate: timestamptz!) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: {
      status: "trial_started"
      trial_start_date: "now()"
      trial_end_date: $trialEndDate
      fee_status: "held"
    }
  ) {
    id
    status
    trial_start_date
    trial_end_date
    fee_status
    updated_at
  }
}

mutation SponsorConfirmPlacement($id: uuid!) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: { sponsor_confirmed: true }
  ) {
    id
    sponsor_confirmed
    agency_confirmed
    updated_at
  }
}

mutation AgencyConfirmPlacement($id: uuid!) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: { agency_confirmed: true }
  ) {
    id
    sponsor_confirmed
    agency_confirmed
    updated_at
  }
}

mutation ConfirmPlacement($id: uuid!, $guaranteeEndDate: timestamptz!) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: {
      status: "placement_confirmed"
      trial_outcome: "passed"
      fee_status: "earned"
      placement_confirmed_date: "now()"
      guarantee_end_date: $guaranteeEndDate
    }
  ) {
    id
    status
    fee_status
    placement_confirmed_date
    guarantee_end_date
    platform_fee_amount
    platform_fee_currency
    agency_id
    maid_id
    sponsor_id
    updated_at
  }
}

mutation FailPlacement($id: uuid!, $reason: String!, $stage: String) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: {
      status: "placement_failed"
      trial_outcome: "failed"
      fee_status: "returned"
      failure_reason: $reason
      failure_stage: $stage
    }
  ) {
    id
    status
    fee_status
    failure_reason
    failure_stage
    agency_id
    maid_id
    sponsor_id
    updated_at
  }
}

mutation UpdateMaidHiredStatus(
  $maidId: String!
  $hiredStatus: String!
  $currentPlacementId: uuid
  $hiredBySponsorId: String
  $hiredDate: timestamptz
  $trialStartDate: timestamptz
  $trialEndDate: timestamptz
) {
  update_maid_profiles(
    where: { id: { _eq: $maidId } }
    _set: {
      hired_status: $hiredStatus
      current_placement_id: $currentPlacementId
      hired_by_sponsor_id: $hiredBySponsorId
      hired_date: $hiredDate
      trial_start_date: $trialStartDate
      trial_end_date: $trialEndDate
    }
  ) {
    affected_rows
    returning {
      id
      hired_status
      current_placement_id
      hired_by_sponsor_id
      hired_date
      trial_start_date
      trial_end_date
    }
  }
}

mutation ResetMaidToAvailable($maidId: String!) {
  update_maid_profiles(
    where: { id: { _eq: $maidId } }
    _set: {
      hired_status: "available"
      current_placement_id: null
      hired_by_sponsor_id: null
      hired_date: null
      trial_start_date: null
      trial_end_date: null
    }
  ) {
    affected_rows
    returning {
      id
      hired_status
    }
  }
}

mutation HoldAgencyFee($id: uuid!) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: { fee_status: "held" }
  ) {
    id
    fee_status
    platform_fee_amount
    platform_fee_currency
    updated_at
  }
}

mutation RefundAgencyFee($id: uuid!) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: { fee_status: "refunded" }
  ) {
    id
    fee_status
    platform_fee_amount
    platform_fee_currency
    updated_at
  }
}

mutation UpdateWorkflowNotes($id: uuid!, $notes: jsonb!) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _set: { notes: $notes }
  ) {
    id
    notes
    updated_at
  }
}

mutation IncrementReminderCount($id: uuid!) {
  update_placement_workflows_by_pk(
    pk_columns: { id: $id }
    _inc: { reminder_sent_count: 1 }
  ) {
    id
    reminder_sent_count
    updated_at
  }
}
